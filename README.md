# Миграция объектов LDAP (eDirectory -> Samba DC)

Данный набор скриптов разработан для миграции и последующей синхронизации объектов LDAP из eDirectory в Samba DC.
Основные функции:

- Перенос объектов: 
  - Организационные единицы – OU;
  - Группы пользователей - Groups, в группы добавляются пользователи;
  - Пользователи - Users, пароли не мигрируют. При миграции, задается временный пароль, который необходимо сменить при первом входе, а также учетная запись отлючается (можно изменить через файл конфигурации)
- Для существующих объектов LDAP (групп, пользователей, OU)поддерживается обноление его свойств: 
  - обновление атрибутов объекта;
  - перемещение объекта в дргуой контейнер;
  - переименование объекта;
  - для групп дополнительно поддерживается обновление состава пользователей.
- Удаление записей (групп, пользователей, OU), которых нет на исходном сервере.

Набор скриптов включает в себя следующие файлы:

- `config.json`: Файл конфигурации;
- `main.py` - Основной модуль
- `connector.py`- модуль для подключения к LDAP и основные операции с записями LDAP
- `data.py`  - модуль инициализации серверов LDAP различных типов
- `logger.py` - модуль логирования действий

# Подготовка окружения
## Библиотеки Python
Для работы скриптов используется Python версии 3.8.18 входящий в состав RedOS 7.3.4

Дополнительно требуются библиотеки:
- pyasn1-0.5.1-py2.py3-none-any.whl
- ldap3-2.9.1-py2.py3-none-any.whl

Для установки необходимо выполнить:
```
pip3 install pyasn1 ldap3
```
Если без интернета, то их нужно предварительно загузить:
```
pip3 download pyasn1 ldap3
```
И далее установить
```
pip3 install --no-index --find-links pyasn1-0.5.1-py2.py3-none-any.whl ldap3-2.9.1-py2.py3-none-any.whl
```

## Расширение схемы

Отслеживание изменений объектов осуществляется на основе сопоставления GIUD объектов. Для этого GUID объекта LDAP исходного сервера сохраняется в отдельный строковый атрибут NovellGUID. Соответсвенно следует раширить схему LDAP целевого сервера для объектов типа группа, пользователь, OU.
Описание расширения схемы приведено в файле [Schema_extend.txt](Schema_extend.txt)


## Подготовка файла конфигурации

Файл конфигурации `config.json` содержит следующие переменные:

### Переменные LDAP

- `LDAP_FILTER_USER`: LDAP-фильтр для получения списка пользователей.
- `LDAP_FILER_GROUP`: LDAP-фильтр для получения списка групп.
- `LDAP_FILER_OU`: LDAP-фильтр для получения списка организационных единиц.
- `READ_DOMAIN_ADMIN_USERNAME`: Учетная запись с правами на чтение LDAP исходного сервера.
- `READ_ADMIN_PASSWORD`: Пароль учетной записи пользователя.
- `READ_DOMAIN_DC_FQDN`: FQDN контроллера домена (сервера eDirectory).
- `READ_ROOT_DN`: Запись RootDN исходного сервера.

### Переменные миграции

- `MIGRATION_DEFAULT_OU`: Base DN организационной единицы, с которой начинается миграция.
- `MIGRATION_LIST_OU`: Список OU, для которых выполняется миграция.

### Переменные записи в Samba DC

- `WRITE_DOMAIN_ADMIN_USERNAME`: Учетная запись пользователя в домене Samba DC с правами записи в LDAP.
- `WRITE_ADMIN_PASSWORD`: Пароль учетной записи пользователя для миграции в домене Samba DC.
- `WRITE_DOMAIN_DC_FQDN`: FQDN контроллера домена Samba DC.
- `WRITE_ROOT_DN`: Запись RootDN домена Samba DC.
- `DEFAULT_USER_MIGRATION_PASSWORD`: Пароль для установки учетным записям пользователей при миграции в домен Samba DC.
- `DISABLE_USER_AFTER_CREATION`: Опция, определяющая, будет ли создаваемая учетная запись отключена или нет (возможны значения True, False).

### Маппинг атрибутов

- `MappingAttr`: Словарь с маппингом атрибутов в формате "атрибут Samba DC:атрибут eDirectory".

# Использование

Запуск процедуры выполняется командой
```
python3 main.py
```

# Описание классов


## Класс LDAP_Connector

В файле `connector.py` определен класс `LDAP_Connector`, который представляет собой расширение класса `Connection` из библиотеки `ldap3`. Этот класс используется для управления подключением к серверу LDAP и выполнения различных операций с записями в каталоге LDAP.

### Методы:

- `__init__`: Инициализирует объект подключения к LDAP серверу с заданными параметрами, такими как FQDN сервера, тип LDAP, учетные данные администратора и корневые Distinguished Names (DN) для исходного и целевого серверов.
- `__get_changed_attr`: Сравнивает атрибуты между двумя словарями и возвращает измененные атрибуты.
- `__lower_case_cn_ou_dc`: Приводит строки DN к нижнему регистру, стандартизируя регистр для атрибутов CN, OU и DC.
- `__is_record_exist`: Проверяет существование записи на целевом сервере по заданному фильтру (например, по novellGUID).
- `search_records`: Выполняет поиск записей в LDAP на основе заданного фильтра и возвращает результаты.
- `convert_dn`: Преобразует DN из формата исходного сервера в формат целевого сервера, заменяя корневой DN.
- `compare_records`: Сравнивает и обновляет записи на целевом сервере, включая переименование и перемещение записей, а также обновление атрибутов.
- `add_ou_record`: Добавляет новую запись organizationalUnit в LDAP-каталог. Предварительно проверяет существование записи по novellGUID и производит сравнение при наличии.
- `add_user_record`: Добавляет новую учетную запись пользователя в LDAP-каталог. Предварительно проверяет существование пользователя по novellGUID и производит сравнение при наличии. Устанавливает пароль, активирует/деактивирует пользователя и устанавливает флаг для смены пароля при первом входе.
- `add_group_record`: Добавляет новую группу в LDAP-каталог. Предварительно проверяет существование записи по novellGUID и производит сравнение при наличии.
- `update_user_membership`: Синхронизирует членство в группе между двумя серверами LDAP. Обновляет состав группы на целевом сервере в соответствии с группой на источнике.
- `delete_records`: Удаляет записи (объекты) из LDAP-каталога на основе переданных идентификаторов объектов.

## Класс CaseInsensitiveDict
Этот класс представляет собой подкласс встроенного класса `dict`, который обрабатывает ключи без учета регистра.

### Методы:

`__setitem__`: Устанавливает элемент словаря, приводя ключ к нижнему регистру.
`__getitem__`: Возвращает элемент словаря, приводя ключ к нижнему регистру
.
Класс словаря, который является регистронезависимым - ключи в нем обрабатываются без учета регистра.

## Класс LDAP_Type (Enum)

В файле `data.py` определен класс `LDAP_Type`, являющийся перечислением (Enum) для представления типов серверов LDAP. Включает следующие значения:

- `ActiveDirectory`: 0
- `SambaDC`: 1
- `FreeIPA`: 2
- `Edirectory`: 3

## Класс Server_Data (Server)

Также в файле `data.py` определен класс `Server_Data`, который представляет данные для сервера LDAP и является наследником класса `Server` из библиотеки `ldap3`.

### Атрибуты

- `fqdn` (str): Fully Qualified Domain Name (FQDN) сервера LDAP.
- `ldap_type` (LDAP_Type): Тип LDAP сервера (ActiveDirectory, SambaDC, FreeIPA, Edirectory).
- `ca_cert_path` (str): Путь к файлу сертификата центра сертификации (CA).

### Методы

- `__init__(fqdn: str, ldap_type: LDAP_Type, ca_certs_path: str = '/var/lib/samba/private/tls/ca.pem')`: Инициализирует атрибуты для создания объекта сервера.
- `get_split_fqdn() -> str`: Возвращает FQDN сервера в формате LDAP, например, "dc01.lab.test" -> "DC=lab,DC=test".

